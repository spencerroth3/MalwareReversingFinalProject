#include "networking.h"

BOOL SendData(struct Connection* conn, unsigned char type, unsigned char* data, unsigned long datasz)
{
	//for now lets send everything as one stream, yaay tcp.
	struct MainHeader header;
	header.type = type;
	header.totalSize = datasz;
	unsigned char* buffer = (unsigned char*)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, sizeof(struct MainHeader) + datasz);
	if (buffer)
	{
		memcpy(buffer, &header, sizeof(struct MainHeader));
		memcpy(buffer + sizeof(struct MainHeader), data, datasz);
		int result = send(conn->sockfd, buffer, sizeof(struct MainHeader) + datasz, 0);
		HeapFree(GetProcessHeap(), 0, buffer);
		return result == datasz + sizeof(struct MainHeader);
	}

	return FALSE;
}

BOOL RecvData(struct Connection* conn, struct MainHeader** output)
{
	char buffer[sizeof(struct MainHeader)];
	if (recv(conn->sockfd, buffer, sizeof(struct MainHeader), MSG_PEEK | MSG_WAITALL) == sizeof(struct MainHeader))
	{
		struct MainHeader* m = (struct MainHeader*)buffer;
		struct MainHeader* recvbuf = (struct MainHeader*)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, sizeof(struct MainHeader) + m->totalSize);
		int result = recv(conn->sockfd, recvbuf, sizeof(struct MainHeader) + m->totalSize, MSG_WAITALL);
		if (result != sizeof(struct MainHeader) + m->totalSize)
		{
			*output = NULL;
			HeapFree(GetProcessHeap(), 0, recvbuf);
			return FALSE;
		}

		*output = recvbuf;
		return TRUE;
	}

	return FALSE;
}