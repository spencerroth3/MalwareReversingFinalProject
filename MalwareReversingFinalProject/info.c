#include "info.h"








void get_MAC_addr(char* addr) //obtain the likely host ip addr.
{
    PIP_ADAPTER_INFO info = (PIP_ADAPTER_INFO)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, sizeof(IP_ADAPTER_INFO));
    ULONG bufSz = sizeof(IP_ADAPTER_INFO);
    if (info)
    {
        if (GetAdaptersInfo(info, &bufSz) == ERROR_BUFFER_OVERFLOW)
        {
            info = (PIP_ADAPTER_INFO)HeapReAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, info, bufSz);
        }

        if (info)
        {
            if (GetAdaptersInfo(info, &bufSz) == ERROR_SUCCESS)
            {
                PIP_ADAPTER_INFO ptr = info;
                while (ptr)
                {
                    if (ptr->Type == MIB_IF_TYPE_ETHERNET || ptr->Type == IF_TYPE_IEEE80211)
                    {
                        memcpy(addr, ptr->Address, 6);
                        break;

                    }
                    ptr = ptr->Next;
                }
            }

            HeapFree(GetProcessHeap(), 0, info);
        }
    }


}


in_addr_t get_ip_addr() //obtain the likely host ip addr.
{
    PIP_ADAPTER_INFO info = (PIP_ADAPTER_INFO)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, sizeof(IP_ADAPTER_INFO));
    ULONG bufSz = sizeof(IP_ADAPTER_INFO);
    if (info)
    {
        if (GetAdaptersInfo(info, &bufSz) == ERROR_BUFFER_OVERFLOW)
        {
            info = (PIP_ADAPTER_INFO)HeapReAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, info, bufSz);
        }

        if (info)
        {
            if (GetAdaptersInfo(info, &bufSz) == ERROR_SUCCESS)
            {
                PIP_ADAPTER_INFO ptr = info;
                while (ptr)
                {
                    if (ptr->Type == MIB_IF_TYPE_ETHERNET || ptr->Type == IF_TYPE_IEEE80211)
                    {
                        in_addr_t result = inet_addr(ptr->IpAddressList.IpAddress.String);

                        HeapFree(GetProcessHeap(), 0, info);
                        return result;
                    }
                    ptr = ptr->Next;
                }
            }

            HeapFree(GetProcessHeap(), 0, info);
        }
    }

    return 0;
}



void getInformation(struct systemInfo* ptr)
{
    DWORD size = sizeof(ptr->userName);
    GetUserNameA(ptr->userName, &size);
    OSVERSIONINFOEXA version;
    version.dwOSVersionInfoSize = sizeof(OSVERSIONINFOEXA);
    GetVersionExA(&version);
    ptr->dwMajorVersion = version.dwMajorVersion;
    ptr->dwMinorVersion = version.dwMinorVersion;
    ptr->wProductType = version.wProductType;
    ptr->ipAddr = get_ip_addr();
    get_MAC_addr(ptr->macAddr);
}